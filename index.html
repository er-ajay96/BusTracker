<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BusTracker — Live (Full)</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<!-- MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />

<style>
  :root{--accent:#0057b8;--muted:#666}
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  #app{display:grid;grid-template-columns:340px 1fr;height:100vh}
  .sidebar{padding:12px;border-right:1px solid #eee;box-sizing:border-box;overflow:auto;background:#fff}
  .mapwrap{position:relative}
  #map{height:100vh;width:100%}
  h1{font-size:18px;margin:0 0 8px}
  label{font-size:13px;color:var(--muted)}
  input,select,button{width:100%;padding:8px;border-radius:6px;border:1px solid #ddd;margin-top:6px;box-sizing:border-box}
  .row{display:flex;gap:8px}
  .small{padding:6px;font-size:13px}
  .card{background:#fafafa;border-radius:8px;padding:10px;margin:8px 0;border:1px solid #eee}
  .user-list{margin-top:10px}
  .user-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:6px}
  .badge{padding:4px 8px;border-radius:999px;background:#eee;font-size:12px}
  .alert-badge{background:#ff4d4f;color:#fff}
  .muted{color:var(--muted);font-size:13px}
  footer{font-size:12px;color:var(--muted);margin-top:12px}
  .controls{display:flex;gap:8px}
  .btn-primary{background:var(--accent);color:#fff;border:none}
  .btn-danger{background:#ff4d4f;color:#fff;border:none}
  .status-online{color:green}
  .status-offline{color:#c00}
  pre{white-space:pre-wrap;word-break:break-all}
</style>
</head>
<body>
<div id="app">
  <div class="sidebar">
    <h1>BusTracker — Live (Full)</h1>

    <div class="card">
      <label for="name">Your name (or bus id)</label>
      <input id="name" placeholder="e.g. A or Bus-1" />
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="startBtn" class="small btn-primary">Start Sharing</button>
        <button id="stopBtn" class="small btn-danger" disabled>Stop</button>
      </div>
      <div style="margin-top:8px">
        <label class="muted">Update interval</label>
        <select id="interval" title="Update interval">
          <option value="900000">15 minutes</option>
          <option value="300000">5 minutes</option>
          <option value="60000">1 minute</option>
        </select>
      </div>
      <div style="margin-top:8px" class="muted">Status: <span id="shareStatus">Not sharing</span></div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Active Users</strong>
        <span id="activeCount" class="badge">0</span>
      </div>
      <div id="users" class="user-list"></div>
    </div>

    <div class="card">
      <strong>Global Controls</strong>
      <div style="margin-top:8px" class="controls">
        <button id="centerAll" class="small">Fit All</button>
        <button id="clearHistory" class="small">Clear All Paths</button>
      </div>
      <div style="margin-top:10px" class="muted">Offline/Network: <span id="netStatus">online</span></div>
    </div>

    <footer>Built with Leaflet + Firebase Realtime DB.<br>Uploads go to <code>locations/{user}/last</code> and <code>locations/{user}/positions</code>.</footer>
  </div>

  <div class="mapwrap">
    <div id="map"></div>
  </div>
</div>

<!-- Firebase compat libs -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<!-- Leaflet + MarkerCluster -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
/* ====== CONFIG ====== */
// Replace with your Firebase config (databaseURL included)
const firebaseConfig = {
  apiKey: "AIzaSyC1FFRx6RDwepBKDfRJF3lRIgbKUZklwA4",
  authDomain: "realtime-database-64cef.firebaseapp.com",
  databaseURL: "https://realtime-database-64cef-default-rtdb.firebaseio.com/",
  projectId: "realtime-database-64cef",
  storageBucket: "realtime-database-64cef.firebasestorage.app",
  messagingSenderId: "705230114876",
  appId: "1:705230114876:web:6c17ee4ebb58ebfa88b339",
  measurementId: "G-QCZLL14SX5"
};
/* ===================== */

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// UI elements
const nameInput = document.getElementById('name');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const intervalSelect = document.getElementById('interval');
const shareStatus = document.getElementById('shareStatus');
const usersDiv = document.getElementById('users');
const activeCountEl = document.getElementById('activeCount');
const centerAllBtn = document.getElementById('centerAll');
const clearHistoryBtn = document.getElementById('clearHistory');
const netStatusEl = document.getElementById('netStatus');

let sharing = false;
let shareIntervalId = null;
let lastPos = null;
let userName = localStorage.getItem('bt_name') || '';
nameInput.value = userName;

// Map setup
const map = L.map('map').setView([20.5937, 78.9629], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom: 19, attribution:'© OpenStreetMap contributors'
}).addTo(map);

// clustering group
const clusterGroup = L.markerClusterGroup();
map.addLayer(clusterGroup);

// per-user state
const users = {}; // user -> { marker, polyline, positions:[], last, battery }
const PATH_COLOR = ['#2b8cbe','#7b3294','#7fbc41','#e31a1c','#ff7f00','#6baed6'];

// Utilities
function nowUTC(){return Date.now();}
function fmtTime(ts){
  if(!ts) return 'never';
  const d = new Date(ts);
  return d.toLocaleString();
}
function haversine(a,b){
  // returns meters
  const toRad = v => v*Math.PI/180;
  const R = 6371000;
  const dlat = toRad(b.lat-a.lat), dlng = toRad(b.lng-a.lng);
  const lat1 = toRad(a.lat), lat2 = toRad(b.lat);
  const hav = Math.sin(dlat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dlng/2)**2;
  return 2*R*Math.asin(Math.sqrt(hav));
}

// Render user list (cards)
function renderUsers(){
  usersDiv.innerHTML = '';
  const keys = Object.keys(users).sort();
  activeCountEl.textContent = keys.length;
  keys.forEach((u,i)=>{
    const s = users[u];
    const el = document.createElement('div');
    el.className = 'user-item';
    const left = document.createElement('div');
    left.innerHTML = `<strong>${u}</strong><div class="muted">Last: ${fmtTime(s.last?.timestamp)}</div>`;
    const right = document.createElement('div');
    const age = s.last ? (nowUTC() - s.last.timestamp) : Infinity;
    const alert = age > 30*60*1000;
    const badge = document.createElement('span');
    badge.className = 'badge' + (alert ? ' alert-badge' : '');
    badge.textContent = alert ? 'stale' : 'ok';
    const info = document.createElement('div');
    info.style.fontSize='12px'; info.style.textAlign='right';
    const battery = s.battery!==undefined ? `Bat:${Math.round(s.battery*100)}%` : '';
    const speed = s.last?.speed ? `${Math.round(s.last.speed)} m/s` : '';
    const acc = s.last?.accuracy ? `${Math.round(s.last.accuracy)}m` : '';
    info.innerHTML = `${speed} ${acc}<div class="muted">${battery}</div>`;
    right.appendChild(badge);
    right.appendChild(info);
    el.appendChild(left);
    el.appendChild(right);
    el.style.borderBottom = '1px solid #f1f1f1';
    usersDiv.appendChild(el);
  });
}

// update or create marker/polyline for user
function updateUserOnMap(user, last, positions, battery){
  let s = users[user];
  if(!s){
    s = { marker: null, polyline: null, positions: [], last:null, battery };
    users[user] = s;
  }
  s.last = last;
  if(battery!==undefined) s.battery = battery;
  // update positions array (keep last N)
  s.positions = positions || s.positions;
  if(s.positions.length>1000) s.positions = s.positions.slice(-1000);

  // polyline
  if(!s.polyline){
    const color = PATH_COLOR[Math.abs(hashCode(user)) % PATH_COLOR.length];
    s.polyline = L.polyline(s.positions.map(p=>[p.lat,p.lng]),{color,weight:4,opacity:0.8}).addTo(map);
  } else {
    s.polyline.setLatLngs(s.positions.map(p=>[p.lat,p.lng]));
  }

  // marker
  const icon = L.divIcon({className:'custom-marker',html:`<div style="background:${pickColor(user)};color:#fff;padding:6px 8px;border-radius:6px">${user}</div>`});
  if(!s.marker){
    s.marker = L.marker([last.lat,last.lng],{icon}).addTo(clusterGroup);
    s.marker.bindPopup(popupHtml(user,s));
  } else {
    s.marker.setLatLng([last.lat,last.lng]);
    s.marker.setPopupContent(popupHtml(user,s));
  }
}

// small deterministic color
function pickColor(name){
  return PATH_COLOR[Math.abs(hashCode(name)) % PATH_COLOR.length];
}
function hashCode(str){
  let h=0; for(let i=0;i<str.length;i++){ h = (h<<5)-h + str.charCodeAt(i); h |= 0; } return h;
}
function popupHtml(user,s){
  const bat = s.battery!==undefined ? `<div>Battery: ${Math.round(s.battery*100)}%</div>` : '';
  const speed = s.last?.speed ? `<div>Speed: ${Math.round(s.last.speed)} m/s</div>` : '';
  const acc = s.last?.accuracy ? `<div>Accuracy: ${Math.round(s.last.accuracy)} m</div>` : '';
  const time = `<div>Last: ${fmtTime(s.last?.timestamp)}</div>`;
  return `<div><strong>${user}</strong>${time}${speed}${acc}${bat}</div>`;
}

// listen to DB
const locRef = db.ref('locations');
locRef.on('value', snap=>{
  const val = snap.val() || {};
  // iterate users
  for(const user in val){
    const last = val[user].last || null;
    // positions may be stored as push keys; convert to array in order
    const posObj = val[user].positions || {};
    const positions = Object.keys(posObj).sort().map(k=>posObj[k]).slice(-500);
    const battery = val[user].battery; // optional
    if(last){
      updateUserOnMap(user,last,positions,battery);
    }
  }
  renderUsers();
});

// Fit all markers
centerAllBtn.addEventListener('click',()=>{
  const allLatLng = [];
  for(const u in users){
    const s = users[u];
    if(s.last) allLatLng.push([s.last.lat,s.last.lng]);
  }
  if(allLatLng.length) map.fitBounds(allLatLng,{padding:[40,40]});
});

// Clear polylines (not DB)
clearHistoryBtn.addEventListener('click',()=>{
  for(const u in users){
    if(users[u].polyline){ map.removeLayer(users[u].polyline); users[u].polyline = null; users[u].positions = []; }
  }
  renderUsers();
});

// network online/offline
window.addEventListener('online', ()=> netStatusEl.textContent = 'online');
window.addEventListener('offline', ()=> netStatusEl.textContent = 'offline');

// Sharing controls
function startSharing(){
  const name = (nameInput.value || '').trim();
  if(!name){ alert('Enter a name or ID'); return; }
  userName = name;
  localStorage.setItem('bt_name', userName);
  sharing = true;
  startBtn.disabled = true;
  stopBtn.disabled = false;
  shareStatus.textContent = 'Sharing as ' + userName;
  sendLocationOnce();
  const ms = parseInt(intervalSelect.value,10) || 900000;
  if(shareIntervalId) clearInterval(shareIntervalId);
  shareIntervalId = setInterval(sendLocationOnce, ms);
}
function stopSharing(){
  sharing = false;
  startBtn.disabled = false;
  stopBtn.disabled = true;
  if(shareIntervalId) clearInterval(shareIntervalId);
  shareStatus.textContent = 'Not sharing';
  // Optionally remove last presence (comment out if you want persistence)
  db.ref('locations/' + userName + '/last').remove().catch(()=>{});
}

startBtn.addEventListener('click', startSharing);
stopBtn.addEventListener('click', stopSharing);

// send location and push to positions
async function sendLocationOnce(){
  if(!navigator.geolocation){
    alert('Geolocation not supported by this browser.');
    return;
  }
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    const accuracy = pos.coords.accuracy || null;
    const timestamp = Date.now();
    // compute speed using last position if available
    const userRef = db.ref('locations/' + userName);
    // read last locally if exists to compute speed
    const lastLocal = users[userName]?.last;
    let speed = null;
    if(lastLocal && lastLocal.latitude && false) {
      // not used
    } else if (lastLocal && lastLocal.timestamp) {
      const lastPos = {lat:lastLocal.lat,lng:lastLocal.lng,timestamp:lastLocal.timestamp};
      const dist = haversine(lastPos,{lat,lng}); // meters
      const dt = (timestamp - lastPos.timestamp)/1000; // seconds
      if(dt>0) speed = dist/dt;
    }
    const lastObj = {lat,lng,accuracy,timestamp,speed};
    // write last and push to positions
    try{
      await userRef.child('last').set(lastObj);
      await userRef.child('positions').push(lastObj);
      // also try to store battery if available
      const bat = await getBatteryLevelSafe();
      if(bat!==undefined) userRef.child('battery').set(bat);
      console.log('Location sent',userName,lastObj);
    }catch(e){
      console.error('Firebase write failed',e);
    }
  }, err=>{
    console.error('Geolocation error',err);
    if(err && err.code===1) alert('Please allow location access for this site.');
  }, {enableHighAccuracy:true, maximumAge:5000});
}

// battery helper (some browsers support)
async function getBatteryLevelSafe(){
  try{
    if(navigator.getBattery){
      const b = await navigator.getBattery();
      return b.level; // 0..1
    }
  }catch(e){}
  return undefined;
}

// Auto-centre when new user appears (once)
let initialCentered=false;
locRef.on('child_added', snap=>{
  if(!initialCentered){
    setTimeout(()=>centerAllBtn.click(),800);
    initialCentered=true;
  }
});

// Auto-prune UI stale users every 10 minutes (client side)
setInterval(()=> {
  const cutoff = Date.now() - 1000*60*60*24; // keep
  for(const u in users){
    // nothing auto-remove; show stale with badge
  }
  renderUsers();
}, 600000);

// try to restore name and auto-start if user asked
if(userName){
  nameInput.value = userName;
  // do not auto-start by default, wait for user to press start
}

/* Debug helpers for desktop testing (optional):
Open console and use:
firebase.database().ref('locations').set({}); OR
firebase.database().ref('locations/Test/last').set({lat:12,lng:77,timestamp:Date.now()});
*/

</script>
</body>
</html>
